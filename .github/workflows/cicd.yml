name: CI-CD

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ===== Backend build (Gradle) =====
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build backend jar
        run: |
          ./gradlew --no-daemon clean bootJar -x test
          ls -la build/libs
      - name: Copy backend artifact
        run: |
          mkdir -p out/backend
          cp build/libs/*.jar out/backend/app.jar

      # ===== Frontend build (React) =====
      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
          ls -la build

      - name: Copy frontend artifacts
        run: |
          mkdir -p out/frontend
          cp -R frontend/build/* out/frontend/

      # ===== Пакуем в один архив для деплоя =====
      - name: Pack release
        run: |
          mkdir -p out/deploy
          cp deploy/nginx.conf out/deploy/nginx.conf || true
          # (nginx нам больше не обязателен, но пусть лежит)
          tar -C out -czf release.tgz backend frontend deploy
          ls -la release.tgz

      - name: Upload build as artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: release
          path: release.tgz

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release
          path: .

      # Копируем архив на Helios по SSH-ключу
      - name: Upload to Helios
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}     # helios.cs.ifmo.ru
          port: ${{ secrets.SSH_PORT }}     # 2222
          username: ${{ secrets.SSH_USER }} # s409361
          key: ${{ secrets.SSH_KEY }}       # приватный ключ БЕЗ пароля
          source: "release.tgz"
          target: "~/islab"
          overwrite: true

      # Разворачиваем и запускаем Spring Boot как сервис-процесс
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            mkdir -p ~/islab
            cd ~/islab

            # 1) распаковать релиз
            rm -rf backend frontend deploy_new
            mkdir -p deploy_new
            tar -xzf release.tgz

            # 2) подготовить структуру
            mkdir -p app www logs
            mv -f backend/app.jar app/app.jar
            rm -rf www/*
            cp -R frontend/* www/

            # 3) записать .env с кредами БД и префиксом образов (не нужен теперь, но пусть будет)
            cat > .env <<EOF
            PG_USER=${{ secrets.PG_USER }}
            PG_PASSWORD=${{ secrets.PG_PASSWORD }}
            EOF
            
            # 4) перезапуск java-процесса (убьём старый, если есть)
            pkill -f "app.jar" || true
            sleep 1
            
            # 5) стартуем новый бэкенд на 18080 с профилем prod
            nohup java -jar app/app.jar \
            --spring.profiles.active=prod \
            --server.port=18080 \
            --spring.web.resources.static-locations=file:/home/studs/${{ secrets.SSH_USER }}/islab/www/ \
            > logs/backend.out 2>&1 < /dev/null &
            
            # 6) показать состояние и последнюю строку лога
            ps aux | grep app.jar | grep -v grep || true
            tail -n 50 logs/backend.out || true
