name: Sync Migrations (Helios)

on:
  workflow_dispatch:
    inputs:
      APPLY:
        description: "Применить миграции после синхронизации (psql)?"
        required: true
        default: "false"
        type: choice
        options: ["false","true"]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect migration folder
        id: detect
        run: |
          set -euo pipefail
          if [ -d "src/main/resources/db/migration" ]; then
            echo "dir=src/main/resources/db/migration" >> $GITHUB_OUTPUT
          elif [ -d "db/migration" ]; then
            echo "dir=db/migration" >> $GITHUB_OUTPUT
          elif [ -d "db.migration" ]; then
            echo "dir=db.migration" >> $GITHUB_OUTPUT
          else
            echo "Не найден каталог миграций (ожидались src/main/resources/db/migration или db/migration или db.migration)"
            exit 1
          fi
          echo "Используем каталог: $(cat $GITHUB_OUTPUT)"

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.HELIOS_SSH_PORT }}" "${{ secrets.HELIOS_HOST }}" >> ~/.ssh/known_hosts

      - name: Write SSH key
        run: |
          echo "${{ secrets.HELIOS_SSH_KEY }}" > ~/.ssh/helios_key
          chmod 600 ~/.ssh/helios_key

      - name: Create remote dirs & backup previous copy
        run: |
          ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" \
            "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" 'bash -s' <<'REMOTE'
            set -eEo pipefail
            APP="$HOME/apps/islab1"
            MIG="$APP/migrations"
            mkdir -p "$MIG"
            # аккуратный бэкап предыдущей версии
            if [ -n "$(ls -A "$MIG" 2>/dev/null || true)" ]; then
              TS="$(date +%Y%m%d%H%M%S)"
              mkdir -p "$APP/migrations_backups"
              tar -czf "$APP/migrations_backups/mig-$TS.tgz" -C "$APP" migrations || true
            fi
          REMOTE

      - name: Rsync migrations to Helios
        run: |
          rsync -avz -e "ssh -i ~/.ssh/helios_key -p ${{ secrets.HELIOS_SSH_PORT }}" \
            "${{ steps.detect.outputs.dir }}/" \
            "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}:~/apps/islab1/migrations/"

      - name: Show remote tree (debug)
        run: |
          ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" \
            "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" 'bash -s' <<'REMOTE'
            set -eEo pipefail
            echo "==== ~/apps/islab1/migrations ===="
            ls -la ~/apps/islab1/migrations
          REMOTE

      - name: (Optional) Apply migrations with psql
        if: ${{ github.event.inputs.APPLY == 'true' }}
        env:
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
        run: |
          # Преобразуем JDBC URL -> URI для psql, напр. jdbc:postgresql://host:5432/db -> postgresql://host:5432/db
          PGURI="${SPRING_DATASOURCE_URL#jdbc:}"
          # Если в URL нет логина/пароля, используем переменные окружения
          ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" \
            "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" 'bash -s' <<'REMOTE'
            set -eEo pipefail
            command -v psql >/dev/null 2>&1 || { echo "psql не найден на сервере"; exit 127; }
          REMOTE

          # Последовательно применяем V*.sql (в порядке сортировки по имени)
          ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" \
            "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" \
            "bash -lc 'set -eEo pipefail; cd ~/apps/islab1/migrations; \
              for f in \$(ls -1 V*.sql | sort); do \
                echo \"===> applying \$f\"; \
                PGPASSWORD=\"$SPRING_DATASOURCE_PASSWORD\" psql \"${PGURI}\" -U \"$SPRING_DATASOURCE_USERNAME\" -v ON_ERROR_STOP=1 -f \"\$f\"; \
              done'"

