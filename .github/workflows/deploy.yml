name: Build & Deploy (Helios, no sudo)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_TOOLCHAIN_VERSION: ${{ secrets.JAVA_TOOLCHAIN_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- FRONTEND ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install & Build Frontend
        working-directory: frontend
        run: |
          npm ci
          CI=false DISABLE_ESLINT_PLUGIN=true npm run build

      # копируем React build внутрь ресурсов Spring (чтобы JAR отдавал статику сам)
      - name: Embed frontend build into Spring resources
        run: |
          rm -rf src/main/resources/static/*
          mkdir -p src/main/resources/static
          rsync -a --delete frontend/build/ src/main/resources/static/

      # ---------- BACKEND ----------
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_TOOLCHAIN_VERSION }}
          cache: 'gradle'

      - name: Grant execute for gradlew
        run: chmod +x ./gradlew

      - name: Build Spring Boot (no tests)
        run: ./gradlew clean bootJar -x test

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp build/libs/*.jar artifact/app.jar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: islab1-artifacts
          path: artifact/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: islab1-artifacts
          path: artifact

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.HELIOS_SSH_PORT }}" "${{ secrets.HELIOS_HOST }}" >> ~/.ssh/known_hosts

      - name: Write SSH key
        run: |
          echo "${{ secrets.HELIOS_SSH_KEY }}" > ~/.ssh/helios_key
          chmod 600 ~/.ssh/helios_key

      - name: Create app directories & scripts on server (idempotent)
        run: |
          ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" \
            "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" bash -lc '
              set -euo pipefail
              APP_DIR="${{ secrets.HELIOS_APP_DIR }}"
              mkdir -p "$APP_DIR/releases" "$APP_DIR/current" "$APP_DIR/logs"
              # .env перезаписываем из секретов при каждом деплое (если каких-то нет — строка будет пустой)
              cat > "$APP_DIR/.env" <<EOF
              SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}
              SERVER_PORT=${{ secrets.SERVER_PORT }}
              SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
              SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
              SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
              EOF
  
              # Скрипты управления
              cat > "$APP_DIR/start.sh" <<'"EOS"'
              #!/usr/bin/env bash
              set -euo pipefail
              APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
              cd "$APP_DIR"
              mkdir -p logs
              if [ -f app.pid ] && ps -p "$(cat app.pid)" > /dev/null 2>&1; then
              echo "Already running with PID $(cat app.pid)"; exit 0
              fi
              set -o allexport
              [ -f "$APP_DIR/.env" ] && source "$APP_DIR/.env"
              set +o allexport
              PORT_OPT=""
              [ -n "${SERVER_PORT:-}" ] && PORT_OPT="-Dserver.port=${SERVER_PORT}"
            nohup java $PORT_OPT -jar "$APP_DIR/app.jar" > "$APP_DIR/logs/app.out.log" 2> "$APP_DIR/logs/app.err.log" &
                echo $! > "$APP_DIR/app.pid"
                echo "Started, PID $(cat "$APP_DIR/app.pid")"
                EOS
                chmod +x "$APP_DIR/start.sh"
    
                cat > "$APP_DIR/stop.sh" <<'"EOS"'
                #!/usr/bin/env bash
                set -euo pipefail
                APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
                cd "$APP_DIR"
                if [ ! -f app.pid ]; then echo "No app.pid"; exit 0; fi
                PID=$(cat app.pid || true)
                if [ -n "$PID" ] && ps -p "$PID" > /dev/null 2>&1; then
                kill "$PID" || true
                sleep 2
                if ps -p "$PID" > /dev/null 2>&1; then kill -9 "$PID" || true; fi
                fi
                rm -f app.pid
                echo "Stopped"
                EOS
                chmod +x "$APP_DIR/stop.sh"
    
                cat > "$APP_DIR/restart.sh" <<'"EOS"'
                #!/usr/bin/env bash
                set -euo pipefail
                APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
                "$APP_DIR/stop.sh" || true
                "$APP_DIR/start.sh"
                EOS
                  chmod +x "$APP_DIR/restart.sh"
                  
                  cat > "$APP_DIR/status.sh" <<'"EOS"'
                  #!/usr/bin/env bash
                  APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
                if [ -f "$APP_DIR/app.pid" ] && ps -p "$(cat "$APP_DIR/app.pid")" > /dev/null 2>&1; then
                echo "RUNNING PID $(cat "$APP_DIR/app.pid")"
                else
                echo "STOPPED"
                fi
                echo "Log tail:"
                tail -n 50 "$APP_DIR/logs/app.out.log" 2>/dev/null || true
                EOS
                chmod +x "$APP_DIR/status.sh"
                '
            
                  - name: Upload JAR to Helios
                    run: |
                      rsync -avz -e "ssh -i ~/.ssh/helios_key -p ${{ secrets.HELIOS_SSH_PORT }}" \
                        artifact/app.jar \
                        "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}:${{ secrets.HELIOS_APP_DIR }}/releases/app-$(date +%Y%m%d%H%M%S).jar"
            
                  - name: Activate and restart on Helios
                    run: |
                      ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" \
                        "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" bash -lc '
                set -euo pipefail
                  APP_DIR="${{ secrets.HELIOS_APP_DIR }}"
                          LATEST=$(ls -1t "$APP_DIR/releases"/app-*.jar | head -n1)
                cp "$LATEST" "$APP_DIR/current/app.jar"
                cd "$APP_DIR/current"
                ../restart.sh
                ../status.sh
                '
