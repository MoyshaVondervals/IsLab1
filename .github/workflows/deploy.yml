name: Build & Deploy (Helios, no sudo)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_TOOLCHAIN_VERSION: ${{ secrets.JAVA_TOOLCHAIN_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- FRONTEND ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install & Build Frontend
        working-directory: frontend
        run: |
          npm ci
          CI=false DISABLE_ESLINT_PLUGIN=true npm run build

      # копируем React build внутрь ресурсов Spring (чтобы JAR отдавал статику сам)
      - name: Embed frontend build into Spring resources
        run: |
          rm -rf src/main/resources/static/*
          mkdir -p src/main/resources/static
          rsync -a --delete frontend/build/ src/main/resources/static/

      # ---------- BACKEND ----------
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_TOOLCHAIN_VERSION }}
          cache: 'gradle'

      - name: Grant execute for gradlew
        run: chmod +x ./gradlew

      - name: Build Spring Boot (no tests)
        run: ./gradlew clean bootJar -x test

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp build/libs/*.jar artifact/app.jar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: islab1-artifacts
          path: artifact/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: islab1-artifacts
          path: artifact

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.HELIOS_SSH_PORT }}" "${{ secrets.HELIOS_HOST }}" >> ~/.ssh/known_hosts

      - name: Write SSH key
        run: |
          echo "${{ secrets.HELIOS_SSH_KEY }}" > ~/.ssh/helios_key
          chmod 600 ~/.ssh/helios_key

      - name: Create app directories & scripts on server (idempotent)
        env:
          SPRING_PROFILES_ACTIVE: ${{ secrets.SPRING_PROFILES_ACTIVE }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
        run: |
          ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" 'bash -s' <<'REMOTE'
          set -eEo pipefail
    
          APP_DIR="$HOME/apps/islab1"
    
          # 1) Директории
          mkdir -p "$APP_DIR/releases" "$APP_DIR/current" "$APP_DIR/logs"
    
          # 2) .env из секретов
          cat > "$APP_DIR/.env" <<ENVEOF
          SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
          SERVER_PORT=${SERVER_PORT}
          SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
          SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
          SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
          ENVEOF
    
          # 3) start.sh
          cat > "$APP_DIR/start.sh" <<'SH'
          #!/usr/bin/env bash
          set -eEo pipefail
          APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          cd "$APP_DIR"
          mkdir -p logs
    
          if [ -f app.pid ] && ps -p "$(cat app.pid)" > /dev/null 2>&1; then
          echo "Already running with PID $(cat app.pid)"
          exit 0
          fi
    
          set -a
          [ -f "$APP_DIR/.env" ] && . "$APP_DIR/.env"
          set +a
    
          PORT_OPT=""
          if [ -n "${SERVER_PORT:-}" ]; then
          PORT_OPT="-Dserver.port=${SERVER_PORT}"
          fi
    
          nohup java $PORT_OPT -jar "$APP_DIR/app.jar" >> "$APP_DIR/logs/app.out.log" 2>> "$APP_DIR/logs/app.err.log" &
          echo $! > "$APP_DIR/app.pid"
          echo "Started, PID $(cat "$APP_DIR/app.pid")"
          SH
          chmod 755 "$APP_DIR/start.sh"
    
          # 4) stop.sh
          cat > "$APP_DIR/stop.sh" <<'SH'
          #!/usr/bin/env bash
          set -eEo pipefail
          APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          cd "$APP_DIR"
    
          if [ ! -f app.pid ]; then
          echo "No app.pid"
          exit 0
          fi
    
          PID="$(cat app.pid || true)"
          if [ -n "$PID" ] && ps -p "$PID" > /dev/null 2>&1; then
          kill "$PID" || true
          sleep 2
          if ps -p "$PID" > /dev/null 2>&1; then kill -9 "$PID" || true; fi
          fi
          rm -f app.pid
          echo "Stopped"
          SH
          chmod 755 "$APP_DIR/stop.sh"
    
          # 5) restart.sh
          cat > "$APP_DIR/restart.sh" <<'SH'
          #!/usr/bin/env bash
          set -eEo pipefail
          APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          "$APP_DIR/stop.sh" || true
          "$APP_DIR/start.sh"
          SH
          chmod 755 "$APP_DIR/restart.sh"
    
          # 6) status.sh
          cat > "$APP_DIR/status.sh" <<'SH'
          #!/usr/bin/env bash
          set -eEo pipefail
          APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          if [ -f "$APP_DIR/app.pid" ]; then
          PID="$(cat "$APP_DIR/app.pid" 2>/dev/null || true)"
          else
          PID=""
          fi
    
          if [ -n "$PID" ] && ps -p "$PID" > /dev/null 2>&1; then
          echo "RUNNING PID $PID"
          else
          echo "STOPPED"
          fi
    
          echo "----- Last 50 log lines (app.out.log) -----"
          tail -n 50 "$APP_DIR/logs/app.out.log" 2>/dev/null || true
          echo "----- Last 50 log lines (app.err.log) -----"
          tail -n 50 "$APP_DIR/logs/app.err.log" 2>/dev/null || true
          SH
          chmod 755 "$APP_DIR/status.sh"
    
          # 7) Проверка наличия файлов
          ls -la "$APP_DIR"
          test -x "$APP_DIR/start.sh"
          test -x "$APP_DIR/restart.sh"
          REMOTE

      - name: Upload JAR to Helios
        run: |
          rsync -avz -e "ssh -i ~/.ssh/helios_key -p ${{ secrets.HELIOS_SSH_PORT }}" \
            artifact/app.jar \
            "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}:~/apps/islab1/releases/app-$(date +%Y%m%d%H%M%S).jar"
      - name: Activate and restart on Helios
        run: |
          ssh -i ~/.ssh/helios_key -p "${{ secrets.HELIOS_SSH_PORT }}" "${{ secrets.HELIOS_SSH_USER }}@${{ secrets.HELIOS_HOST }}" 'bash -s' <<'REMOTE'
          set -eEo pipefail
          APP_DIR="$HOME/apps/islab1"
    
          LATEST="$(ls -1t "$APP_DIR/releases"/app-*.jar | head -n1)"
          if [ -z "$LATEST" ] || [ ! -f "$LATEST" ]; then
          echo "No JAR found in $APP_DIR/releases"
          exit 1
          fi
    
          cp "$LATEST" "$APP_DIR/current/app.jar"
    
          if [ -x "$APP_DIR/restart.sh" ]; then
          "$APP_DIR/restart.sh"
          else
          echo "restart.sh missing, doing manual restart"
          if [ -x "$APP_DIR/stop.sh" ]; then "$APP_DIR/stop.sh" || true; fi
          if [ -x "$APP_DIR/start.sh" ]; then "$APP_DIR/start.sh"; else echo "start.sh missing"; exit 1; fi
          fi
    
          "$APP_DIR/status.sh" || true
          REMOTE
